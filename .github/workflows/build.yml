name: Build Unified Backend Executable

on:
  push:
    branches:
      - main
    paths:
      - 'frontend/public/backend-unified.py'
      - '.github/workflows/build.yml'

jobs:
  build-unified:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    - name: Free up disk space
      run: |
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        sudo rm -rf /usr/local/share/boost
        sudo rm -rf "$AGENT_TOOLSDIRECTORIES"
        sudo apt-get clean
        sudo rm -rf /var/lib/apt/lists/*
        df -h
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        pip install fastapi==0.115.0 uvicorn[standard]==0.32.0 pyngrok==7.2.0 requests==2.32.3 boto3==1.35.66 python-multipart==0.0.12 aiofiles==24.1.0 langchain==0.3.7 langchain-community==0.3.7 chromadb==0.5.20 sentence-transformers==3.2.1 PyMuPDF==1.24.13 langchain-huggingface==0.1.2 langchain-chroma==0.1.4 langchain-ollama==0.2.0 langchain-experimental==0.3.3 flashrank pydantic==2.9.2 python-dotenv==1.0.1 psutil==6.0.0
    - name: Build executable
      run: |
        pyinstaller --onedir --name backend-unified frontend/public/backend-unified.py
    - name: Clean up build files
      run: |
        rm -rf build/
        rm -rf frontend/ ai-backend/ chroma_store/ image_store/ progress-service/ proxy-backend/
        df -h
    - name: Create zip archive
      run: |
        cd dist
        zip -r backend-unified.zip backend-unified/
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: backend-unified-zip
        path: dist/backend-unified.zip

  release:
    needs: [build-unified]
    runs-on: ubuntu-latest
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: ./artifacts
    - name: Create release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: backend-${{ github.run_number }}
        release_name: Unified Backend Executable ${{ github.run_number }}
        draft: false
        prerelease: false
    - name: Upload Unified executable zip
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./artifacts/backend-unified-zip/backend-unified.zip
        asset_name: backend-unified.zip
        asset_content_type: application/zip